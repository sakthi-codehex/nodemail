var express = require('express');
var app = express();
var api_key = 'key-202621ef3bda58743661d2e163bdac15';
var domain = 'sandbox9fe370943eb44419ba8bd90a81ac6fdf.mailgun.org';
var mailgun = require('mailgun-js')({apiKey: api_key, domain: domain});
//var http = require('http');
//var qs = require('querystring');
var latitude = 0.0;
var longitude = 0.0;
var address = "";
var reservation = 0;
var hotelid = "";
var date = "";
var time = "";
var numberofpersons = 0;
var url = "";
var geocoderProvider = 'google';
var httpAdapter = 'https';
var geocoder = require('node-geocoder')(geocoderProvider, httpAdapter, extra);
var extra = {
    apiKey: 'AIzaSyB7Sc0sUfd0V8ed_P5NX0hopvDHvAmjzk0',
    formatter: null
};
var type;
app.get('/', function(request, response){
	reservation = request.query.ResId;
            hotelid = request.query.HotelId;
            date = request.query.PickupDate;
            time = request.query.PickupTime;
            numberofpersons = request.query['No.OfPersons'];
            latitude = request.query.Latitude;
            longitude = request.query.Longitude;
	type = request.query.Type;
	if(type == "c")
	{
		geocoder.reverse({ lat: latitude, lon: longitude })
            .then(function (res) {
                console.log(res[0].formattedAddress);
                address = res[0].formattedAddress;
                var htmldata = "<!DOCTYPE html><html><head> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\"/> <title>PAS - Crotus Technologies</title> <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css\"> <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css\" integrity=\"sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7/\" crossorigin=\"anonymous\"> <style type=\"text/css\"> html{width: 100%;height: 100%;padding: 0px;margin: 0px;}body{width: 100%;height: 100%;padding: 0px;margin: 0px;font-family: 'Open Sans';}.usernametextlabel>span{font-weight: 600; float: left;}.loginregistercontainer{width: 100%;height: 100%;padding: 0px;margin: 0px; background-color: #f9f9f9;font-family: 'Open Sans'; display: table;}.landingpagecontainer{width: 100%;height: 100%;padding: 0px;margin: 0px; background-color: #f9f9f9;font-family: 'Open Sans';}.loginpic{width: 30px; height: 30px; border-radius: 15px;}.loginregistercontents{display: table-cell; vertical-align: middle;}.logoimg{width: auto; height: auto; padding: 10px;}.loginregisterbox{border: solid 2px #ebebeb; border-radius: 5px;}.loginselectbutton{text-decoration: none !important; padding: 0px !important; text-align: center !important; font-family:'Open Sans' !important; font-size: 20px !important;}.loginselectbutton>p{padding: 10px !important; text-align: center !important; font-family:'Open Sans' !important; color: #6e6e6e; font-size: 20px !important; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.loginselectbutton>p:hover{color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupselectbutton{text-decoration: none !important; padding: 0px !important; text-align: center !important; font-family:'Open Sans' !important; font-size: 20px !important;}.signupselectbutton>p{padding: 10px !important; text-align: center !important; font-family:'Open Sans' !important; color: #6e6e6e; font-size: 20px !important; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupselectbutton>p:hover{color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.border-right{border-right: 1px solid #29aae2;}.border-left{border-left: 1px solid #29aae2;}.logintabpane{min-height:350px;}.signuptabpane{min-height:350px;}.usernametextlabel{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 16px !important;}.passwordtextlabel{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 16px !important;}.loginbutton{color: white !important; background-color: #29aae2 !important; padding: 5px; width: 100px;-webkit-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);-moz-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.loginbutton:hover{-webkit-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);-moz-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupbutton{color: white !important; background-color: #29aae2 !important; padding: 5px; width: 100px;-webkit-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);-moz-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupbutton:hover{-webkit-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);-moz-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.padding-leftnone{padding-left: 0px !important;}.codehextextloginsignupscreen{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 10px !important;}.codehextextloginsignupscreen>a{text-decoration: none; color: #6e6e6e; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.codehextextloginsignupscreen>a:hover{text-decoration: none; color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}</style></head><body> <div class=\"loginregistercontainer\"> <div class=\"loginregistercontainer\"> <div class=\"loginregistercontents\"> <div class=\"logocontainer\"> <center> <img src=\"http://www.crotustechnologies.com/images/logo.png\" class=\"img-responsive logoimg\" alt=\"logo Image\"> <br></center> </div><div class=\"container-fluid padding-leftnone padding-rightnone\"> <div class=\"row padding-leftnone padding-rightnone\"> <div class=\"col-lg-1 hidden-md hidden-sm hidden-xs padding-leftnone\"> </div><div class=\"col-lg-10\"> <div class=\"loginregisterbox\"> <div class=\"container-fluid\"> <div class=\"row\"> <ul class=\"nav nav-tabs\" role=\"tablist\"> <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12\"> <center> <a href=\"#login\" aria-controls=\"login\" role=\"tab\" data-toggle=\"tab\" class=\"loginselectbutton \"> <p>Cab Booking Details</p></a> </center> </div></ul> <br><div class=\"tab-content\"> <div role=\"tabpanel\" class=\"tab-pane fade in active logintabpane\" id=\"login\"> <div class=\"container-fluid\"> <div class=\"row\"> <div class=\"col-lg-1 col-md-2 col-sm-2 hidden-xs\"></div><div class=\"col-lg-10 col-md-8 col-sm-8 col-xs-8\"> <br><form> <div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"><p class=\"usernametextlabel\">Reservation Number : </p></div><div class=\"col-xs-5\"><p class=\"usernametextlabel\"><span>" + reservation + "</span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"><p class=\"usernametextlabel\">Number Of Persons : </p></div><div class=\"col-xs-5\"><p class=\"usernametextlabel\"><span>" + numberofpersons + "</span> </p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Latitude : </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + latitude + "</span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Longitude : </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + longitude + "</span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Address : </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span> " + address + " </span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Date : </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + date + "</span> </p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Time : </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + time + "</span> </p></div></div></div></form> <br></div><div class=\"col-lg-1 col-md-2 col-sm-2 col-xs-2\"></div></div></div></div></div></div></div></div></div><div class=\"col-lg-1 hidden-md hidden-sm hidden-xs padding-rightnone\"> </div></div></div><center> <p class=\"codehextextloginsignupscreen\"> Powered by <a href=\"http://codehex.in\" target=\"_blank\"> &copy;CodeheX</a> </p></center> </div></div></div><script>$('#myTabs a').click(function (e){e.preventDefault() $(this).tab('show')}) </script> <script src=\"https://code.jquery.com/jquery-2.1.4.min.js\"></script> <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js\" integrity=\"sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS\" crossorigin=\"anonymous\"></script></body></html>";
                var datas = {
                    from: 'sakthi.codehex <postmaster@sandbox9fe370943eb44419ba8bd90a81ac6fdf.mailgun.org>',
                    to: 'demo.frontdesk.boston@gmail.com',
                    subject: 'New Cab Booking',
                    html: htmldata
                };
                mailgun.messages().send(datas, function (error, bodye) {
                    console.log(bodye);
                });
            })
            .catch(function (err) {
                console.log(err);
            });
            console.log(address);
	}
	else
	{
		var res = request.query.ResId;
		var hot = request.query.HotelId;
	        var bod = request.query.BookingDate;
	        var bok = request.query.BookingTime;
	        var nop = request.query["No.OfPersons"];
		var htmldata = "<!DOCTYPE html><html><head> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\"/> <title>PAS - Crotus Technologies</title> <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css\"> <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css\" integrity=\"sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7\" crossorigin=\"anonymous\"> <style type=\"text/css\"> html{width: 100%;height: 100%;padding: 0px;margin: 0px;}body{width: 100%;height: 100%;padding: 0px;margin: 0px;font-family: 'Open Sans';} .usernametextlabel>span{font-weight: 600; float: left;} .loginregistercontainer{width: 100%;height: 100%;padding: 0px;margin: 0px; background-color: #f9f9f9;font-family: 'Open Sans'; display: table;} .landingpagecontainer{width: 100%;height: 100%;padding: 0px;margin: 0px; background-color: #f9f9f9;font-family: 'Open Sans';}.loginpic{width: 30px; height: 30px; border-radius: 15px;}.loginregistercontents{display: table-cell; vertical-align: middle;}.logoimg{width: auto; height: auto; padding: 10px;}.loginregisterbox{border: solid 2px #ebebeb; border-radius: 5px;}.loginselectbutton{text-decoration: none !important; padding: 0px !important; text-align: center !important; font-family:'Open Sans' !important; font-size: 20px !important;}.loginselectbutton>p{padding: 10px !important; text-align: center !important; font-family:'Open Sans' !important; color: #6e6e6e; font-size: 20px !important; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.loginselectbutton>p:hover{color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupselectbutton{text-decoration: none !important; padding: 0px !important; text-align: center !important; font-family:'Open Sans' !important; font-size: 20px !important;}.signupselectbutton>p{padding: 10px !important; text-align: center !important; font-family:'Open Sans' !important; color: #6e6e6e; font-size: 20px !important; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupselectbutton>p:hover{color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.border-right{border-right: 1px solid #29aae2;}.border-left{border-left: 1px solid #29aae2;}.logintabpane{min-height:350px;}.signuptabpane{min-height:350px;}.usernametextlabel{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 16px !important;}.passwordtextlabel{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 16px !important;}.loginbutton{color: white !important; background-color: #29aae2 !important; padding: 5px; width: 100px;-webkit-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);-moz-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.loginbutton:hover{-webkit-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);-moz-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupbutton{color: white !important; background-color: #29aae2 !important; padding: 5px; width: 100px;-webkit-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);-moz-box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11);box-shadow: 2px 0px 27px 8px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.signupbutton:hover{-webkit-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);-moz-box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11);box-shadow: 10px 13px 14px -80px rgba(0,0,0,0.11); -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.padding-leftnone{padding-left: 0px !important;}.codehextextloginsignupscreen{font-family:'Open Sans' !important; color: #6e6e6e; padding: 5px !important; font-size: 10px !important;}.codehextextloginsignupscreen>a{text-decoration: none; color: #6e6e6e; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}.codehextextloginsignupscreen>a:hover{text-decoration: none; color: #29aae2; -moz-transition: all .5s ease-in-out; -webkit-transition: all .5s ease-in-out; transition: all .5s ease-in-out;}/*Login Page ends here*//*==========================================*/</style></head><body> <div class=\"loginregistercontainer\"> <div class=\"loginregistercontainer\"> <div class=\"loginregistercontents\"> <div class=\"logocontainer\"> <center> <img src=\"http://www.crotustechnologies.com/images/logo.png\" class=\"img-responsive logoimg\" alt=\"logo Image\"> <br></center> </div><div class=\"container-fluid padding-leftnone padding-rightnone\"> <div class=\"row padding-leftnone padding-rightnone\"> <div class=\"col-lg-1 hidden-md hidden-sm hidden-xs padding-leftnone\"> </div><div class=\"col-lg-10\"> <div class=\"loginregisterbox\"> <div class=\"container-fluid\"> <div class=\"row\"> <ul class=\"nav nav-tabs\" role=\"tablist\"> <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12\"> <center> <a href=\"#login\" aria-controls=\"login\" role=\"tab\" data-toggle=\"tab\" class=\"loginselectbutton \"> <p>Table Booking Details</p></a> </center> </div></ul> <br><div class=\"tab-content\"> <div role=\"tabpanel\" class=\"tab-pane fade in active logintabpane\" id=\"login\"> <div class=\"container-fluid\"> <div class=\"row\"> <div class=\"col-lg-1 col-md-2 col-sm-2 col-xs-2\"></div><div class=\"col-lg-10 col-md-8 col-sm-8 col-xs-8\"> <br><form> <div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"><p class=\"usernametextlabel\">Reservation Number:</p></div><div class=\"col-xs-5\"><p class=\"usernametextlabel\"><span>" + res + "</span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"><p class=\"usernametextlabel\">Number Of Persons:</p></div><div class=\"col-xs-5\"><p class=\"usernametextlabel\"><span>"+nop+" </span> </p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\"> Restaurant: </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + hot + "</span></p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Date: </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + bod + "</span> </p></div></div></div><div class=\"form-group\"> <div class=\"row\"> <div class=\"col-xs-7\"> <p class=\"usernametextlabel\">Time: </p></div><div class=\"col-xs-5\"> <p class=\"usernametextlabel\"><span>" + bok + "</span> </p></div></div></div></form> <br></div><div class=\"col-lg-1 col-md-2 col-sm-2 col-xs-2\"></div></div></div></div></div></div></div></div></div><div class=\"col-lg-1 hidden-md hidden-sm hidden-xs padding-rightnone\"> </div></div></div><center> <p class=\"codehextextloginsignupscreen\"> Powered by <a href=\"http://codehex.in\" target=\"_blank\"> &copy;CodeheX</a> </p></center> </div></div></div><script>$('#myTabs a').click(function (e){e.preventDefault() $(this).tab('show')}) </script> <script src=\"https://code.jquery.com/jquery-2.1.4.min.js\"></script> <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js\" integrity=\"sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS\" crossorigin=\"anonymous\"></script></body></html>";
	var datas = {
            from: 'sakthi.codehex <postmaster@sandbox9fe370943eb44419ba8bd90a81ac6fdf.mailgun.org>',
            to: 'demo.frontdesk.boston@gmail.com',
            subject: 'New Table Booking',
            html: htmldata
        };
        mailgun.messages().send(datas, function (error, bodye) {
            console.log(bodye);
        });
	}
  response.send('ResId: ' + request.query.ResId);
});

app.listen(8080, 'localhost', function() {
  //console.log("... port %d in %s mode", app.address().port, app.settings.env);
});